# -*-shell-script-*-
# TOPDIR, ARCH and DIST should be passed in from outside
#test -z "$TOPDIR" && echo "error:  TOPDIR undefined" 1>&2 && exit 1
test -z "$ARCH" && echo "error:  ARCH undefined" 1>&2 && exit 1
test -z "$DIST" && echo "error:  DIST undefined" 1>&2 && exit 1

if [ -d dists/ ]; then
    BINDMOUNTS=$TOPDIR/dists/
    OTHERMIRROR="deb [arch=$ARCH] file://$TOPDIR/ $DIST main"
else
    OTHERMIRROR=""
fi

# Debian configuration
DEBIAN_SUITES=("buster" "stretch" "jessie" "wheezy")
DEBIAN_MIRROR="ftp.debian.org"

# Ubuntu configuration
UBUNTU_SUITES=("trusty")
UBUNTU_MIRROR="ftp.ubuntu.com"

OLD_UBUNTU_SUITES=("precise" "lucid")
OLD_UBUNTU_MIRROR="archive.ubuntu.com"

# Keyring file
KEYRING=${TOPDIR}/pbuilder/keyring.gpg
APTKEYRINGS=("${APTKEYRINGS[@]}" "$KEYRING")

# Distribution
DISTRIBUTION=${DIST}

# Base tarball
BASETGZ="${TOPDIR}/pbuilder/${DIST}/${ARCH}/base.tgz"

# Where to build
BUILDPLACE="${TOPDIR}/tmp"

# Where to place finished pkgs
BUILDRESULT="pbuilder/${DIST}/${ARCH}/pkgs"

# cache for packages
APTCACHE="${TOPDIR}/aptcache/${DIST}/${ARCH}/"

# ccache
CCACHEDIR="${TOPDIR}/ccache"
test -d ${CCACHEDIR} || mkdir -p ${CCACHEDIR}

# hook directory
HOOKDIR="${TOPDIR}/pbuilder"

# set arch in debootstrap
DEBOOTSTRAPOPTS=(
    "${DEBOOTSTRAPOPTS[@]}"
    "--arch=${ARCH}"
    "--keyring=${KEYRING}"
)

# set arch for create mode
ARCHITECTURE=${ARCH}

if $(echo ${DEBIAN_SUITES[@]} | grep -q $DIST); then
    MIRRORSITE="http://$DEBIAN_MIRROR/debian/"
    COMPONENTS="main"
    OTHERMIRROR="${OTHERMIRROR}|deb [arch=$ARCH] http://${DEBIAN_MIRROR}/debian $DIST-backports main"

elif $(echo ${UBUNTU_SUITES[@]} | grep -q $DIST); then
    MIRRORSITE="http://$UBUNTU_MIRROR/ubuntu/"
    COMPONENTS="main universe"
    OTHERMIRROR="${OTHERMIRROR}|deb [arch=$ARCH] http://${UBUNTU_MIRROR}/ubuntu $DIST-backports main universe"

elif $(echo ${OLD_UBUNTU_SUITES[@]} | grep -q $DIST); then
    MIRRORSITE="http://$OLD_UBUNTU_MIRROR/ubuntu/"
    COMPONENTS="main universe"
    OTHERMIRROR="${OTHERMIRROR}|deb [arch=$ARCH] http://${OLD_UBUNTU_MIRROR}/ubuntu $DIST-backports main"

else
    echo "Unknown distribution: $DIST"
    exit 1
fi


# unexport ARCH; messes with at least kernel pkgs
export -n ARCH; unset ARCH


# Print diagnostics
echo "script = $(basename $0)"
for i in BASETGZ DISTRIBUTION APTCACHE MIRRORSITE COMPONENTS \
    DEBOOTSTRAPOPTS[@] OTHERMIRROR BINDMOUNTS; do
    eval echo "$i = \${$i}"
done
